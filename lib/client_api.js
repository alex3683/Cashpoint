var nowjs = require( 'now' );

exports.initialize = function( httpServer, storage, debtCalculator ) {
   var everyone = nowjs.initialize( httpServer );

   everyone.now.log = function( msg ) {
      console.log( "Logged: " + msg );
   };

   ///////////////////////////////////////////////////////////////////////////////////////////////////////////

   everyone.now.addUser = function( user, callback ) {
      storage.addUser( user, callback );
   };

   ///////////////////////////////////////////////////////////////////////////////////////////////////////////

   everyone.now.addVoucherForUser = function( voucher, user, callback ) {
      storage.addVoucherForUser( voucher, user, callback );
   };

   ///////////////////////////////////////////////////////////////////////////////////////////////////////////

   everyone.now.getVouchers = function( callback ) {
      storage.getVouchers( callback );
   };

   ///////////////////////////////////////////////////////////////////////////////////////////////////////////

   everyone.now.getNonRepaidVouchers = function( callback ) {
      storage.getNonRepaidVouchers( callback );
   };

   ///////////////////////////////////////////////////////////////////////////////////////////////////////////

   everyone.now.getUsers = function( callback ) {
      storage.getUsers( callback );
   };

   ///////////////////////////////////////////////////////////////////////////////////////////////////////////

   everyone.now.calculateDebts = function( callback ) {
      debtCalculator.calculateDebts( callback );
   };

   ///////////////////////////////////////////////////////////////////////////////////////////////////////////

   storage.setEventRouter( function( event ) {
      everyone.now.handleEvent( event );
   } );

};
